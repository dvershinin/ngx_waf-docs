(window.webpackJsonp=window.webpackJsonp||[]).push([[38],{427:function(_,v,t){"use strict";t.r(v);var e=t(46),a=Object(e.a)({},(function(){var _=this,v=_.$createElement,t=_._self._c||v;return t("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[t("h1",{attrs:{id:"配置语法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置语法"}},[_._v("#")]),_._v(" 配置语法")]),_._v(" "),t("h2",{attrs:{id:"waf"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#waf"}},[_._v("#")]),_._v(" "),t("code",[_._v("waf")])]),_._v(" "),t("ul",[t("li",[_._v("配置语法: waf <"),t("em",[_._v("on")]),_._v(" | "),t("em",[_._v("off")]),_._v(">")]),_._v(" "),t("li",[_._v("默认配置：waf "),t("em",[_._v("off")])]),_._v(" "),t("li",[_._v("配置段: http, server, location")])]),_._v(" "),t("p",[_._v("是否启用本模块。")]),_._v(" "),t("h2",{attrs:{id:"waf-rule-path"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#waf-rule-path"}},[_._v("#")]),_._v(" "),t("code",[_._v("waf_rule_path")])]),_._v(" "),t("ul",[t("li",[_._v("配置语法: waf_rule_path <*dir*>")]),_._v(" "),t("li",[_._v("默认配置：——")]),_._v(" "),t("li",[_._v("配置段: http, server, location")])]),_._v(" "),t("p",[_._v("规则文件所在目录，且必须以"),t("code",[_._v("/")]),_._v("结尾。")]),_._v(" "),t("h2",{attrs:{id:"waf-mode"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#waf-mode"}},[_._v("#")]),_._v(" "),t("code",[_._v("waf_mode")])]),_._v(" "),t("ul",[t("li",[_._v("配置语法: waf_mode <"),t("em",[_._v("mode_type")]),_._v("> ...")]),_._v(" "),t("li",[_._v("默认配置：——")]),_._v(" "),t("li",[_._v("配置段: http, server, location")])]),_._v(" "),t("p",[_._v("指定防火墙的工作模式，至少指定一个模式，最多指定八个模式。")]),_._v(" "),t("p",[t("code",[_._v("mode_type")]),_._v("具有下列取值（不区分大小写）:")]),_._v(" "),t("ul",[t("li",[_._v("GET: 当"),t("code",[_._v("Http.Method=GET")]),_._v("时启动检查。")]),_._v(" "),t("li",[_._v("HEAD: 当"),t("code",[_._v("Http.Method=HEAD")]),_._v("时启动检查。")]),_._v(" "),t("li",[_._v("POST: 当"),t("code",[_._v("Http.Method=POST")]),_._v("时启动检查。")]),_._v(" "),t("li",[_._v("PUT: 当"),t("code",[_._v("Http.Method=PUT")]),_._v("时启动检查。")]),_._v(" "),t("li",[_._v("DELETE: 当"),t("code",[_._v("Http.Method=DELETE")]),_._v("时启动检查。")]),_._v(" "),t("li",[_._v("MKCOL: 当"),t("code",[_._v("Http.Method=MKCOL")]),_._v("时启动检查。")]),_._v(" "),t("li",[_._v("COPY: 当"),t("code",[_._v("Http.Method=COPY")]),_._v("时启动检查。")]),_._v(" "),t("li",[_._v("MOVE: 当"),t("code",[_._v("Http.Method=MOVE")]),_._v("时启动检查。")]),_._v(" "),t("li",[_._v("OPTIONS: 当"),t("code",[_._v("Http.Method=OPTIONS")]),_._v("时启动检查。")]),_._v(" "),t("li",[_._v("PROPFIN: 当"),t("code",[_._v("Http.Method=PROPFIN")]),_._v("时启动检查。")]),_._v(" "),t("li",[_._v("PROPPATCH: 当"),t("code",[_._v("Http.Method=PROPPATCH")]),_._v("时启动检查。")]),_._v(" "),t("li",[_._v("LOCK: 当"),t("code",[_._v("Http.Method=LOCK")]),_._v("时启动检查。")]),_._v(" "),t("li",[_._v("UNLOCK: 当"),t("code",[_._v("Http.Method=UNLOCK")]),_._v("时启动检查。")]),_._v(" "),t("li",[_._v("PATCH: 当"),t("code",[_._v("Http.Method=PATCH")]),_._v("时启动检查。")]),_._v(" "),t("li",[_._v("TRAC: 当"),t("code",[_._v("Http.Method=TRAC")]),_._v("时启动检查。")]),_._v(" "),t("li",[_._v("CMN-METH：等价于 "),t("code",[_._v("HEAD GET POST")]),_._v("。")]),_._v(" "),t("li",[_._v("ALL-METH：任意的 HTTP 请求方法都会启动检查。")]),_._v(" "),t("li",[_._v("IP: 启用 IP 地址的检查规则。")]),_._v(" "),t("li",[_._v("URL: 启用 url 的检查规则。")]),_._v(" "),t("li",[_._v("RBODY: 启用 POST 请求体的检查规则。")]),_._v(" "),t("li",[_._v("ARGS: 启用 args 的检查规则。")]),_._v(" "),t("li",[_._v("UA: 启用 user-agent 的检查规则。")]),_._v(" "),t("li",[_._v("COOKIE: 启用 cookie 的检查规则。")]),_._v(" "),t("li",[_._v("REFERER: 启用 referer 的检查规则。")]),_._v(" "),t("li",[_._v("CC: 启用 CC 防御。"),t("strong",[_._v("当你启用了此模式，你必须设置 "),t("a",{attrs:{href:"#waf-cc-deny"}},[_._v("waf_cc_deny")]),_._v("。")])]),_._v(" "),t("li",[_._v("ADV：启用高级规则。")]),_._v(" "),t("li",[_._v("LIB-INJECTION-SQLI：使用 "),t("a",{attrs:{href:"https://github.com/libinjection/libinjection",target:"_blank",rel:"noopener noreferrer"}},[_._v("libinjection"),t("OutboundLink")],1),_._v(" 检测 SQL 注入。")]),_._v(" "),t("li",[_._v("LIB-INJECTION-XSS：使用 "),t("a",{attrs:{href:"https://github.com/libinjection/libinjection",target:"_blank",rel:"noopener noreferrer"}},[_._v("libinjection"),t("OutboundLink")],1),_._v(" 检测 XSS 攻击。")]),_._v(" "),t("li",[_._v("LIB-INJECTION：等价于 "),t("code",[_._v("LIB-INJECTION-SQLI LIB-INJECTION-XSS")]),_._v("。")]),_._v(" "),t("li",[_._v("CACHE：启用缓存。启用此模式后会缓存检查的结果，下次检查相同的目标时就不需要重复检查了。不过不会缓存 POST 体的检查结果。比如一个 URL 经过检查后并没有在黑名单中，那么下次检查相同的 URL 时就无需再次检查 URL 黑名单了。"),t("strong",[_._v("当你启用了此模式，你必须设置 "),t("a",{attrs:{href:"#waf-cache"}},[_._v("waf_cache")])]),_._v("。")]),_._v(" "),t("li",[_._v("STD：标准工作模式，等价于 "),t("code",[_._v("HEAD GET POST IP URL RBODY ARGS UA CC CACHE LIB-INJECTION-SQLI")]),_._v("。")]),_._v(" "),t("li",[_._v("STATIC：适用于静态站点的工作模式，等价于 "),t("code",[_._v("HEAD GET IP URL UA CC CACHE")]),_._v("。")]),_._v(" "),t("li",[_._v("DYNAMIC：适用于动态站点的工作模式，等价于 "),t("code",[_._v("HEAD GET POST IP URL ARGS UA RBODY COOKIE CC CACHE LIB-INJECTION-SQLI")]),_._v("。")]),_._v(" "),t("li",[_._v("FULL: 启用所有的模式。")])]),_._v(" "),t("p",[_._v("您可以通过在某个 "),t("code",[_._v("mode_type")]),_._v(" 前增加 "),t("code",[_._v("!")]),_._v(" 前缀来关闭该模式，下面是一个例子。\n表示使用标准的工作模式，但是不检查 User-Agent。")]),_._v(" "),t("div",{staticClass:"language-nginx extra-class"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[_._v("waf_mode")]),_._v(" STD !UA")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v(";")]),_._v("\n")])])]),t("div",{staticClass:"custom-block warning"},[t("p",{staticClass:"custom-block-title"},[_._v("注意")]),_._v(" "),t("p",[_._v("如果同时启用两个及以上的存在冲突的模式，则靠右的模式会覆盖它左边的模式。下面的例子表示检查 User-Agent。")]),_._v(" "),t("div",{staticClass:"language-nginx extra-class"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[_._v("waf_mode")]),_._v(" !UA STD")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v(";")]),_._v("\n")])])])]),_._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[_._v("注意")]),_._v(" "),t("p",[t("code",[_._v("CC")]),_._v("是独立于其它模式的模式，其生效与否不受到其它模式的影响。典型情况如"),t("code",[_._v("URL")]),_._v("模式会受到"),t("code",[_._v("GET")]),_._v("模式的影响，因为如果不使用"),t("code",[_._v("GET")]),_._v("模式，那么在收到"),t("code",[_._v("GET")]),_._v("请求时就不会启动检查，自然也就不会检查 URL，但是"),t("code",[_._v("CC")]),_._v("模式不会受到类似的影响。")])]),_._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[_._v("最新的 Current 版本中的变化")]),_._v(" "),t("p",[_._v("参数 "),t("code",[_._v("CC")]),_._v(" 和 "),t("code",[_._v("CACHE")]),_._v(" 被删除。")]),_._v(" "),t("ul",[t("li",[_._v("STD：标准工作模式，等价于 "),t("code",[_._v("HEAD GET POST IP URL RBODY ARGS UA")]),_._v("。")]),_._v(" "),t("li",[_._v("STATIC：适用于静态站点的工作模式，等价于 "),t("code",[_._v("HEAD GET IP URL UA")]),_._v("。")]),_._v(" "),t("li",[_._v("DYNAMIC：适用于动态站点的工作模式，等价于 "),t("code",[_._v("HEAD GET POST IP URL ARGS UA RBODY COOKIE")]),_._v("。")]),_._v(" "),t("li",[_._v("LIBINJECTION：已移除。")]),_._v(" "),t("li",[_._v("LIBINJECTION-SQLI：已移除。")]),_._v(" "),t("li",[_._v("LIBINJECTION-XSS：已移除。")]),_._v(" "),t("li",[_._v("ADV：已移除。")])])]),_._v(" "),t("h2",{attrs:{id:"waf-cc-deny"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#waf-cc-deny"}},[_._v("#")]),_._v(" "),t("code",[_._v("waf_cc_deny")])]),_._v(" "),t("ul",[t("li",[_._v("配置语法: waf_cc_deny <rate="),t("em",[_._v("n")]),_._v("r/m> [duration="),t("em",[_._v("1h")]),_._v("] [size="),t("em",[_._v("20m")]),_._v("]")]),_._v(" "),t("li",[_._v("默认配置：——")]),_._v(" "),t("li",[_._v("配置段: http, server, location")])]),_._v(" "),t("p",[_._v("设置 CC 防护相关的参数。")]),_._v(" "),t("ul",[t("li",[t("code",[_._v("rate")]),_._v("：表示一段时间内的请求次数的上限，如 "),t("code",[_._v("500r/m")]),_._v("。超出限制后会返回 "),t("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/503",target:"_blank",rel:"noopener noreferrer"}},[_._v("503 状态码"),t("OutboundLink")],1),_._v("，并附带 "),t("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Retry-After",target:"_blank",rel:"noopener noreferrer"}},[_._v("Retry-After"),t("OutboundLink")],1),_._v(" 响应头。")]),_._v(" "),t("li",[t("code",[_._v("duration")]),_._v("：表示超出第一个参数 "),t("code",[_._v("rate")]),_._v(" 的限制后拉黑 IP 的时间，如 "),t("code",[_._v("60s")]),_._v("、"),t("code",[_._v("60m")]),_._v("、"),t("code",[_._v("60h")]),_._v(" 和 "),t("code",[_._v("60d")]),_._v("，如不指定则默认为 "),t("code",[_._v("1h")]),_._v("。")]),_._v(" "),t("li",[t("code",[_._v("size")]),_._v("：用于设置记录 IP 访问次数的内存的大小，如 "),t("code",[_._v("20m")]),_._v("、"),t("code",[_._v("2048k")]),_._v("，不得小于 "),t("code",[_._v("20m")]),_._v("，如不指定则默认为 "),t("code",[_._v("20m")]),_._v("。当这段内存耗尽的时候程序会按照 LRU 策略清理一部分访问记录。")])]),_._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[_._v("估算所需的内存大小")]),_._v(" "),t("p",[_._v("经过估计，1M 的内存至少可以记录 4096 个 IP。")])]),_._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[_._v("最新的 Current 版本中的变化")]),_._v(" "),t("ul",[t("li",[_._v("配置语法: waf_cc_deny <"),t("em",[_._v("off")]),_._v(" | "),t("em",[_._v("on")]),_._v(" | "),t("em",[_._v("CAPTCHA")]),_._v("> <rate="),t("em",[_._v("n")]),_._v("r/t> [duration="),t("em",[_._v("1h")]),_._v("] [size="),t("em",[_._v("20m")]),_._v("]")]),_._v(" "),t("li",[_._v("默认配置：waf_cc_deny "),t("em",[_._v("off")]),_._v(" duration="),t("em",[_._v("1h")]),_._v(" size="),t("em",[_._v("20m")])]),_._v(" "),t("li",[_._v("配置段: server, location")])]),_._v(" "),t("hr"),_._v(" "),t("ul",[t("li",[t("code",[_._v("CAPTCHA")]),_._v("：当请求频率超出设定值时会使用验证码进行验证，如果连续三次验证失败则拉黑 IP，反之重新计算请求频率。你可以参考"),t("RouterLink",{attrs:{to:"/zh-cn/practice/enable-captcha.html"}},[_._v("开启验证码 | 最佳实践")]),_._v("中的用例。\n当你启用了此选项时，你必须设置 "),t("a",{attrs:{href:"#waf-captcha"}},[_._v("waf_captcha")]),_._v(" 的 "),t("code",[_._v("prov")]),_._v("、"),t("code",[_._v("file")]),_._v(" 和 "),t("code",[_._v("secret")]),_._v(" 这三个参数。")],1),_._v(" "),t("li",[t("code",[_._v("rate")]),_._v("：表示一段时间内的请求次数的上限，如 "),t("code",[_._v("500r/s")]),_._v("、"),t("code",[_._v("500r/60s")]),_._v("、"),t("code",[_._v("500r/m")]),_._v("、"),t("code",[_._v("500r/60m")]),_._v("、"),t("code",[_._v("500r/h")]),_._v("、"),t("code",[_._v("500r/60h")]),_._v(" 和 "),t("code",[_._v("500r/d")]),_._v("。超出限制后会返回 "),t("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/503",target:"_blank",rel:"noopener noreferrer"}},[_._v("503 状态码"),t("OutboundLink")],1),_._v("，并附带 "),t("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Retry-After",target:"_blank",rel:"noopener noreferrer"}},[_._v("Retry-After"),t("OutboundLink")],1),_._v(" 响应头。")])])]),_._v(" "),t("h2",{attrs:{id:"waf-cache"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#waf-cache"}},[_._v("#")]),_._v(" "),t("code",[_._v("waf_cache")])]),_._v(" "),t("ul",[t("li",[_._v("配置语法: waf_cache <capacity="),t("em",[_._v("n")]),_._v(">")]),_._v(" "),t("li",[_._v("默认配置：—")]),_._v(" "),t("li",[_._v("配置段: http, server, location")])]),_._v(" "),t("p",[_._v("设置缓存规则检查结果相关的参数。")]),_._v(" "),t("ul",[t("li",[t("code",[_._v("capacity")]),_._v("：对于一些启用了缓存机制的检测项目，每个检测项目最多缓存多少个检测目标的检测结果。")])]),_._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[_._v("启用了缓存机制的检测项目")]),_._v(" "),t("p",[_._v("启用了缓存机制的检测项目指除了 CC 防护、IP 黑白名单检测和 POST 检测之外的所有的检测项。")])]),_._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[_._v("性能优化建议")]),_._v(" "),t("p",[t("code",[_._v("capacity")]),_._v(" 过小会导致频繁地淘汰缓存，增加内存碎片，降低性能。所以请根据实际应用场景合理地设置。")])]),_._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[_._v("最新的 Current 版本中的变化")]),_._v(" "),t("ul",[t("li",[_._v("配置语法: waf_cache <"),t("em",[_._v("off")]),_._v(" | "),t("em",[_._v("on")]),_._v("> [capacity="),t("em",[_._v("50")]),_._v("]")]),_._v(" "),t("li",[_._v("默认配置：waf_cache "),t("em",[_._v("off")]),_._v(" \\capacity="),t("em",[_._v("50")])]),_._v(" "),t("li",[_._v("配置段: server, location")])])]),_._v(" "),t("h2",{attrs:{id:"waf-modsecurity"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#waf-modsecurity"}},[_._v("#")]),_._v(" "),t("code",[_._v("waf_modsecurity")]),_._v(" "),t("Badge",{attrs:{text:"仅限最新的 Current 版本",type:"tip"}})],1),_._v(" "),t("ul",[t("li",[_._v("配置语法: waf_modsecurity <"),t("em",[_._v("on")]),_._v(" | "),t("em",[_._v("off")]),_._v("> <file=*/path/to/modsecuriy/rules.conf*> <remote_key="),t("em",[_._v("key")]),_._v("> <remote_url="),t("em",[_._v("url")]),_._v(">")]),_._v(" "),t("li",[_._v("默认配置：waf_modsecurity off")]),_._v(" "),t("li",[_._v("配置段: http, server, location")])]),_._v(" "),t("p",[_._v("使用 ModSecurity 的规则。")]),_._v(" "),t("ul",[t("li",[t("code",[_._v("file")]),_._v("：规则文件的绝对路径。")]),_._v(" "),t("li",[t("code",[_._v("remote_key")]),_._v("：用于读取远程规则文件的密钥。")]),_._v(" "),t("li",[t("code",[_._v("remote_url")]),_._v("：用于读取远程文件的 URL。")])]),_._v(" "),t("p",[_._v("你可以参考 "),t("a",{attrs:{href:"/zh-cn/practice/enable-modsecurity"}},[_._v("开启 ModSecurity | 最佳实践")]),_._v(" 中的用法。")]),_._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[_._v("注意")]),_._v(" "),t("ul",[t("li",[_._v("如果你使用了参数 "),t("code",[_._v("remote_key")]),_._v("，你必须同时使用参数 "),t("code",[_._v("remote_url")]),_._v("。")]),_._v(" "),t("li",[_._v("如果你同时使用了参数 "),t("code",[_._v("file")]),_._v("、"),t("code",[_._v("remote_key")]),_._v(" 和 "),t("code",[_._v("remote_url")]),_._v("，那么两份规则都会被加载。")])])]),_._v(" "),t("h2",{attrs:{id:"waf-modsecurity-transaction-id"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#waf-modsecurity-transaction-id"}},[_._v("#")]),_._v(" "),t("code",[_._v("waf_modsecurity_transaction_id")]),_._v(" "),t("Badge",{attrs:{text:"仅限最新的 Current 版本",type:"tip"}})],1),_._v(" "),t("ul",[t("li",[_._v("配置语法: waf_modsecurity_transaction_id <"),t("em",[_._v("string")]),_._v(">")]),_._v(" "),t("li",[_._v("默认配置：waf_modsecurity off")]),_._v(" "),t("li",[_._v("配置段: http, server, location")])]),_._v(" "),t("p",[_._v("指定 ModSecurity 的事务 ID。你可以在此处使用常量字符串和变量，下面是一个例子。")]),_._v(" "),t("div",{staticClass:"language-nginx extra-class"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[_._v("server")])]),_._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v("{")]),_._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[_._v("location")]),_._v(" /file/")]),_._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v("{")]),_._v("\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[_._v("waf_modsecurity_transaction_id")]),_._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[_._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[_._v("$host")]),_._v('-file"')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v(";")]),_._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v("}")]),_._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[_._v("location")]),_._v(" /api/")]),_._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v("{")]),_._v("\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[_._v("waf_modsecurity_transaction_id")]),_._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[_._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[_._v("$host")]),_._v('-api"')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v(";")]),_._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v("}")]),_._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[_._v("}")]),_._v("\n")])])]),t("h2",{attrs:{id:"waf-captcha"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#waf-captcha"}},[_._v("#")]),_._v(" "),t("code",[_._v("waf_captcha")]),_._v(" "),t("Badge",{attrs:{text:"仅限最新的 Current 版本",type:"tip"}})],1),_._v(" "),t("ul",[t("li",[_._v("配置语法: waf_captcha <"),t("em",[_._v("on")]),_._v(" | "),t("em",[_._v("off")]),_._v("> <prov="),t("em",[_._v("hCaptcha")]),_._v(" | "),t("em",[_._v("reCAPTCHAv2")]),_._v(" | "),t("em",[_._v("reCAPTCHAv3")]),_._v("> <file="),t("em",[_._v("/full/path")]),_._v("> <secret="),t("em",[_._v("your_secret")]),_._v("> [score="),t("em",[_._v("0.5")]),_._v("] [expire=30m] [api="),t("em",[_._v("uri")]),_._v("] [verify="),t("em",[_._v("/captcha")]),_._v("]")]),_._v(" "),t("li",[_._v("默认配置：waf_captcha off")]),_._v(" "),t("li",[_._v("配置段: http, server, location")])]),_._v(" "),t("p",[_._v("使用验证码对客户端进行人机识别。")]),_._v(" "),t("ul",[t("li",[t("code",[_._v("prov")]),_._v("：验证码平台，包含 "),t("a",{attrs:{href:"https://www.hcaptcha.com/",target:"_blank",rel:"noopener noreferrer"}},[_._v("hCaptcha"),t("OutboundLink")],1),_._v("、"),t("a",{attrs:{href:"https://www.google.com/recaptcha/about/",target:"_blank",rel:"noopener noreferrer"}},[_._v("reCAPTCHAv2"),t("OutboundLink")],1),_._v(" 和 "),t("a",{attrs:{href:"https://www.google.com/recaptcha/about/",target:"_blank",rel:"noopener noreferrer"}},[_._v("reCAPTCHAv3"),t("OutboundLink")],1),_._v("。")]),_._v(" "),t("li",[t("code",[_._v("file")]),_._v("：用于接入验证码的 HTML 文件的绝对路径，你可以从 "),t("code",[_._v("assets/")]),_._v(" 下找到对应的 HTML 文件。")]),_._v(" "),t("li",[t("code",[_._v("secret")]),_._v("：用于确认验证码的运行结果的密钥，你可以从对应的验证码平台获得。")]),_._v(" "),t("li",[t("code",[_._v("socre")]),_._v("：当 "),t("code",[_._v("prov=reCAPTCHAv3")]),_._v(" 时，这个表示验证码打分结果的下限，低于这个值会被视为验证失败。默认值为 "),t("code",[_._v("0.5")]),_._v("。")]),_._v(" "),t("li",[t("code",[_._v("expire")]),_._v("：验证码的过期时间，过期后需要重新运行验证码。默认为 30 分钟。")]),_._v(" "),t("li",[t("code",[_._v("api")]),_._v("：验证码平台的提供给服务端的 API，用于确认验证码的运行结果。\n"),t("ul",[t("li",[_._v("如果 "),t("code",[_._v("prov=hCaptcha")]),_._v("，则默认值为 "),t("code",[_._v("https://hcaptcha.com/siteverify")]),_._v("。")]),_._v(" "),t("li",[_._v("如果 "),t("code",[_._v("prov=reCAPTCHAv2")]),_._v("，则默认值为 "),t("code",[_._v("https://www.recaptcha.net/recaptcha/api/siteverify")]),_._v("。")]),_._v(" "),t("li",[_._v("如果 "),t("code",[_._v("prov=reCAPTCHAv3")]),_._v("，则默认值为 "),t("code",[_._v("https://www.recaptcha.net/recaptcha/api/siteverify")]),_._v("。")])])]),_._v(" "),t("li",[t("code",[_._v("verify")]),_._v("：验证码向后端提交 token 所用的 url，默认为 "),t("code",[_._v("/captcha")]),_._v("。")])]),_._v(" "),t("p",[_._v("你可以参考"),t("RouterLink",{attrs:{to:"/zh-cn/practice/enable-captcha.html"}},[_._v("开启验证码 | 最佳实践")]),_._v("中的用例。")],1),_._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[_._v("填写你的 Sitekey")]),_._v(" "),t("p",[_._v("你可以在 "),t("code",[_._v("assets/")]),_._v(" 目录下找到接入每个验证码所使用的 HTML 并拷贝一份，然后在副本中填入你的 "),t("code",[_._v("Sitekey")]),_._v("。")])]),_._v(" "),t("h2",{attrs:{id:"waf-verify-bot"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#waf-verify-bot"}},[_._v("#")]),_._v(" "),t("code",[_._v("waf_verify_bot")]),_._v(" "),t("Badge",{attrs:{text:"仅限最新的 Current 版本",type:"tip"}})],1),_._v(" "),t("ul",[t("li",[_._v("配置语法: waf_verify_bot <"),t("em",[_._v("off")]),_._v(" | "),t("em",[_._v("on")]),_._v(" | "),t("em",[_._v("strict")]),_._v("> ["),t("em",[_._v("who")]),_._v("] ...")]),_._v(" "),t("li",[_._v("默认配置：waf_captcha "),t("em",[_._v("off")]),_._v(" "),t("em",[_._v("GoogleBot")]),_._v(" "),t("em",[_._v("BingBot")]),_._v(" "),t("em",[_._v("BaiduSpider")]),_._v(" "),t("em",[_._v("YandexBot")])]),_._v(" "),t("li",[_._v("配置段: http, server, location")])]),_._v(" "),t("p",[_._v("验证友好的爬虫，比如百度蜘蛛。")]),_._v(" "),t("p",[_._v("如果第一个参数是 "),t("code",[_._v("on")]),_._v(" 则会停止后续的所有检查并放行本次请求。")]),_._v(" "),t("p",[_._v("如果第一个参数是 "),t("code",[_._v("strict")]),_._v("，则如果某个请求的 User-Agent 正确，但是 IP 地址不正确则会被拦截（有误报）。")]),_._v(" "),t("ul",[t("li",[t("code",[_._v("who")]),_._v("：爬虫的名称，取值包括 "),t("code",[_._v("GoogleBot")]),_._v("、"),t("code",[_._v("BingBot")]),_._v("、"),t("code",[_._v("BaiduSpider")]),_._v(" 和 "),t("code",[_._v("YandexBot")]),_._v("。如不指定则默认为全部。")])]),_._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[_._v("工作原理")]),_._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://developers.google.com/search/docs/advanced/crawling/overview-google-crawlers",target:"_blank",rel:"noopener noreferrer"}},[_._v("Overview of Google crawlers (user agents)  |  Search Central"),t("OutboundLink")],1)]),_._v(" "),t("li",[t("a",{attrs:{href:"https://developers.google.com/search/docs/advanced/crawling/verifying-googlebot",target:"_blank",rel:"noopener noreferrer"}},[_._v("Googlebot Verification | Google Search Central  |  Google Developers"),t("OutboundLink")],1)]),_._v(" "),t("li",[t("a",{attrs:{href:"https://www.bing.com/webmasters/help/which-crawlers-does-bing-use-8c184ec0",target:"_blank",rel:"noopener noreferrer"}},[_._v("Which Crawlers Does Bing Use? - Bing Webmaster Tools"),t("OutboundLink")],1)]),_._v(" "),t("li",[t("a",{attrs:{href:"https://www.bing.com/webmasters/help/how-to-verify-bingbot-3905dc26",target:"_blank",rel:"noopener noreferrer"}},[_._v("How to Verify Bingbot"),t("OutboundLink")],1)]),_._v(" "),t("li",[t("a",{attrs:{href:"https://help.baidu.com/question?prod_id=99&class=0&id=3001",target:"_blank",rel:"noopener noreferrer"}},[_._v("百度用户服务中心-站长平台"),t("OutboundLink")],1)]),_._v(" "),t("li",[t("a",{attrs:{href:"https://yandex.com/support/webmaster/robot-workings/check-yandex-robots.html",target:"_blank",rel:"noopener noreferrer"}},[_._v("How to check that a robot belongs to Yandex"),t("OutboundLink")],1)])])]),_._v(" "),t("h2",{attrs:{id:"waf-under-attack"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#waf-under-attack"}},[_._v("#")]),_._v(" "),t("code",[_._v("waf_under_attack")])]),_._v(" "),t("ul",[t("li",[_._v("配置语法: waf_under_attack <"),t("em",[_._v("on")]),_._v(" | "),t("em",[_._v("off")]),_._v("> [uri="),t("em",[_._v("str")]),_._v("]")]),_._v(" "),t("li",[_._v("默认配置：waf_under_attack off")]),_._v(" "),t("li",[_._v("配置段: http, server, location")])]),_._v(" "),t("p",[_._v("如果您的站点正在受到攻击可以尝试使用此配置。\n开启后每个用户首次访问会强制延迟五秒，并自动跳转到 "),t("code",[_._v("uri")]),_._v(" 所指向的网页。")]),_._v(" "),t("p",[_._v("如果攻击者采用攻击方式不能完美支持 Cookie，本功能可以大幅度缓解此类攻击造成的影响。")]),_._v(" "),t("ul",[t("li",[t("code",[_._v("uri")]),_._v(": 可以是一个完整的网址，也可以是一个路径。比如 "),t("code",[_._v("https://example.com/attack.html")]),_._v(" 或 "),t("code",[_._v("/attack.html")]),_._v("。")])]),_._v(" "),t("p",[_._v("你可以参考"),t("RouterLink",{attrs:{to:"/zh-cn/practice/protect-against-distributed-http-flood.html"}},[_._v("抵御分布式 CC 攻击（HTTP 洪水） | 最佳实践")]),_._v("中的用例。")],1),_._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[_._v("小技巧")]),_._v(" "),t("p",[t("code",[_._v("uri")]),_._v(" 所指向的网页应该在五秒后自动跳转到用户想要访问的页面，页面的网址可以通过查询字符串获得，参数名为 "),t("code",[_._v("target")]),_._v("。")]),_._v(" "),t("p",[t("code",[_._v("assets/under-attack.html")]),_._v(" 是一个示例网页，你应该将这个文件拷贝到你的网站目录下，并正确地配置 "),t("code",[_._v("uri")]),_._v("。")]),_._v(" "),t("p",[_._v("你自然也可以自己编写一个 html 文件，然后通过 "),t("code",[_._v("uri")]),_._v(" 指向它。")])]),_._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[_._v("最新的 Current 版本中的变化")]),_._v(" "),t("p",[_._v("在 LTS 版本中我们通过重定向实现了该功能，但是许多原因（如缓存和 CDN）会导致重定向失败，或者不能正常验证 Cookie。\n所以我们修改了实现方式，我们通过修改响应体来返回指定的网页，这种方式不会导致 URI 的改变。")]),_._v(" "),t("p",[_._v("同时我们增加了响应头 "),t("code",[_._v("Cache-Control: no-store")]),_._v(" 以避免缓存带来的影响。")]),_._v(" "),t("ul",[t("li",[_._v("移除了参数 "),t("code",[_._v("uri")]),_._v("。")]),_._v(" "),t("li",[_._v("增加了参数 "),t("code",[_._v("file")]),_._v("，该参数的值应该是一个 HTML 文件的绝对路径，如 "),t("code",[_._v("file=/path/to/under-attack.html")]),_._v("。这个 HTML 只有一个功能，即五秒后自动刷新。")])])]),_._v(" "),t("h2",{attrs:{id:"waf-priority"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#waf-priority"}},[_._v("#")]),_._v(" "),t("code",[_._v("waf_priority")])]),_._v(" "),t("ul",[t("li",[_._v('配置语法: waf_priority "'),t("em",[_._v("str")]),_._v('"')]),_._v(" "),t("li",[_._v('默认配置：waf_priority "W-IP IP CC UNDER-ATTACK W-URL URL ARGS UA W-REFERER REFERER COOKIE ADV"')]),_._v(" "),t("li",[_._v("配置段: http, server, location")])]),_._v(" "),t("p",[_._v("设置各个检测项目的优先级，除了 POST 检测，POST 检测的优先级永远最低。")]),_._v(" "),t("ul",[t("li",[t("code",[_._v("UNDER-ATTACK")]),_._v(": 配置 "),t("code",[_._v("waf_under_attack")]),_._v("。")]),_._v(" "),t("li",[t("code",[_._v("W-IP")]),_._v("：IP 白名单检测")]),_._v(" "),t("li",[t("code",[_._v("IP")]),_._v("：IP 黑名单检测")]),_._v(" "),t("li",[t("code",[_._v("CC")]),_._v("：CC 防护")]),_._v(" "),t("li",[t("code",[_._v("W-URL")]),_._v("：URL 白名单检测")]),_._v(" "),t("li",[t("code",[_._v("URL")]),_._v("：URL 黑名单检测")]),_._v(" "),t("li",[t("code",[_._v("ARGS")]),_._v("：URL 参数（查询字符串）黑名单检测")]),_._v(" "),t("li",[t("code",[_._v("UA")]),_._v("：User-Agent 黑名单检测")]),_._v(" "),t("li",[t("code",[_._v("W-REFERER")]),_._v("：Referer 白名单检测")]),_._v(" "),t("li",[t("code",[_._v("REFERER")]),_._v("：Referer 黑名单检测")]),_._v(" "),t("li",[t("code",[_._v("COOKIE")]),_._v("：Cookie 黑名单检测")]),_._v(" "),t("li",[t("code",[_._v("ADV")]),_._v("：表示高级规则。")])]),_._v(" "),t("div",{staticClass:"custom-block warning"},[t("p",{staticClass:"custom-block-title"},[_._v("警告")]),_._v(" "),t("p",[t("code",[_._v("str")]),_._v(" 必须使用单引号或者双引号包裹，且 "),t("code",[_._v("str")]),_._v(" 必须包含全部的检测项目。")])]),_._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[_._v("最新的 Current 版本中的变化")]),_._v(" "),t("ul",[t("li",[_._v('默认配置：waf_priority "W-IP IP VERIFY-BOT CC CAPTCHA UNDER-ATTACK W-URL URL ARGS UA W-REFERER REFERER COOKIE POST MODSECURITY"')])]),_._v(" "),t("hr"),_._v(" "),t("ul",[t("li",[t("code",[_._v("VERIFY-BOT")]),_._v("：友好爬虫验证。")]),_._v(" "),t("li",[t("code",[_._v("CAPTCHA")]),_._v("：验证码。")]),_._v(" "),t("li",[t("code",[_._v("POST")]),_._v("：请求体黑名单。")]),_._v(" "),t("li",[t("code",[_._v("ADV")]),_._v("：已经移除。")]),_._v(" "),t("li",[t("code",[_._v("MODSECURITY")]),_._v("。")])])]),_._v(" "),t("h2",{attrs:{id:"waf-http-status"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#waf-http-status"}},[_._v("#")]),_._v(" "),t("code",[_._v("waf_http_status")])]),_._v(" "),t("ul",[t("li",[_._v("配置语法: waf_http_status [general="),t("em",[_._v("http_status_code")]),_._v("] [cc_deny="),t("em",[_._v("http_status_code")]),_._v("]")]),_._v(" "),t("li",[_._v("默认配置: waf_http_status general=403 cc_deny=503")]),_._v(" "),t("li",[_._v("配置段: http, server, location")])]),_._v(" "),t("p",[_._v("此指令用于设置请求被拦截时返回的 HTTP 状态码。")]),_._v(" "),t("ul",[t("li",[t("code",[_._v("general")]),_._v(": 表示所有基于黑名单的检测项目触发后返回的 HTTP 状态码。")]),_._v(" "),t("li",[t("code",[_._v("cc_deny")]),_._v("：表示 CC 防护触发后返回的 HTTP 状态码。")])])])}),[],!1,null,null,null);v.default=a.exports}}]);